# Архитектура системы пошагового передвижения на основе Command Pattern

## Обзор системы

Система реализует пошаговую игровую механику с использованием паттерна Command, обеспечивающего:

- Масштабируемость и поддерживаемость
- Поддержка истории команд
- Возможность отмены/повтора действий
- Сложное взаимодействие сущностей
- Пошаговую очередь выполнения

## Структура проекта

```
Commands/
├── ICommand.cs              # Интерфейс команды
├── Command.cs               # Абстрактный базовый класс команды
├── MoveCommand.cs           # Команда перемещения
├── AttackCommand.cs         # Команда атаки
├── WaitCommand.cs           # Команда пропуска хода
└── CompositeCommand.cs      # Композитная команда

Managers/
├── CommandManager.cs        # Управление выполнением команд
├── HistoryManager.cs        # Управление историей команд
└── CommandPool.cs           # Пул команд для оптимизации

Systems/
├── TurnSystem.cs            # Система очередности ходов
└── InputCommandHandler.cs   # Обработчик ввода команд
```

## Компоненты системы

### 1. Базовая структура команд

#### ICommand.cs
```csharp
public interface ICommand
{
    bool CanExecute();
    IEnumerator Execute();
    void Undo();
    void Redo();
}
```

#### Command.cs (абстрактный класс)
```csharp
public abstract class Command : ICommand
{
    public Entity Executor { get; set; }
    public abstract bool CanExecute();
    public abstract IEnumerator Execute();
    public virtual void Undo() { }
    public virtual void Redo() { }
    public virtual void SaveState() { }
    public virtual void RestoreState() { }
}
```

### 2. Конкретные команды

#### MoveCommand.cs
- Проверяет возможность перемещения на указанную клетку
- Обрабатывает перемещение через двери
- Анимирует движение
- Сохраняет предыдущее состояние для отмены

#### AttackCommand.cs
- Проверяет наличие цели в направлении атаки
- Анимирует фазы атаки (приготовление, выпад, возврат)
- Наносит урон цели
- Обрабатывает смерть противника

### 3. Системы управления

#### CommandManager.cs
- Управляет очередью выполнения команд
- Обеспечивает асинхронное выполнение
- Интегрируется с системой ввода
- Координирует смену ходов

#### HistoryManager.cs
- Хранит историю выполненных команд
- Поддерживает фиксированный размер истории
- Обеспечивает функции отмены/повтора
- Использует циклический буфер для оптимизации

## Интеграция с текущей архитектурой

Система будет интегрироваться с:
- Существующим `MovementService` через адаптер
- `EventBus` для оповещения о событиях
- `InputSystem` для обработки команд игрока
- `GameStateMachine` для управления состоянием игры
- `GameHubHandler` как основной точкой входа